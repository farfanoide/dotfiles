#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# Description
# -----------
#
#   Simple script to create github repo and add it as a remote.
#
# ------------------------------------------------------------------------------
# Author
# -------
#
#  * Farfanoide (https://github.com/farfanoide)
#
# ------------------------------------------------------------------------------

set -e

_git_repo_exists ()    { [ -d '.git' ] ;}
_create_repo ()
{
    local ENDPOINT='https://api.github.com/user/repos'
    local REPO_DATA="{\"name\":\"${REPO_NAME}\"}"

    curl --silent -u ${USERNAME} ${ENDPOINT} -d "${REPO_DATA}" \
        | grep ssh_url \
        | cut -d'"'  -f4
}
_repo_was_created () { [ ! -z "${REPO_URL}" ] ;}
_origin_is_set ()    { git remote -v | grep -q origin ;}

main ()
{
    if ! _git_repo_exists 2> /dev/null; then
        git init .
    fi

    REPO_URL="$(_create_repo)"

    if _repo_was_created; then
        echo "Created https://github.com/${USERNAME}/${REPO_NAME}"
        if ! _origin_is_set; then
            git remote add origin $REPO_URL && \
                echo "Added ${REPO_URL} as 'origin' remote."
        fi
    else
        echo "Failed to create repo. Re check your credentials." \
            && exit 1
    fi
}

if [ $# -eq 0 ] || [[ "$1" =~ 'h' ]] ; then
    echo "Usage: $(basename $0) <repository_name> [username]" \
        && exit 1
fi

# Arguments parsing, really lame, but it kinda works..
REPO_NAME=$1; shift

if [ $# -gt 0 ] ; then
    USERNAME="$1"
else
    USERNAME="$(git config github.user)"
fi

main
